<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <% include ../../partialA/head %>
    <link rel="stylesheet" href="/stylesheets/cropper.min.css" />
    <style media="screen">
      .img-label img {
        width: 25rem;
      }
      .img-label {
        cursor: pointer;
      }
      .img-container img {
        max-width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="container-scroller">
      <!-- partial:../../partials/_navbar.html -->
      <% include ../../partialA/navbar %>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
        <!-- partial:../../partials/_sidebar.html -->
        <% include ../../partialA/sidebar %>
        <!-- partial -->
        <div class="main-panel">
          <div class="content-wrapper">
            <div class="row">
              <div class="col-12 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <h4 class="card-title">Update Book</h4>
                    <form
                      class="forms-sample"
                      action="#"
                      method="POST"
                      id="frm"
                      enctype="multipart/form-data"
                      name="frm"
                    >
                    <input type="hidden" name="id" value="<%= book._id %>">
                      <div class="form-group">
                        <label for="exampleInputName1">Name</label>
                        <input
                          type="text"
                          class="form-control"
                          id="exampleInputName1"
                          value="<%= book.name %>"
                          name="name"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label for="auth_name">Author Name</label>
                        <input
                          type="text"
                          class="form-control"
                          id="auth_name"
                          value="<%= book.author_name %>"
                          name="auth_name"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label for="pushDate">Publish Date</label>
                        <input
                          type="date"
                          class="form-control"
                          id="pushDate"
                          value="<%= book.pushDate%>"
                          name="pushDate"
                          required
                        />
                      </div>
                      <div class="form-group row">
                        <label class="col-lg-4 col-form-label" for="book_author"
                          >Image <span class="text-danger">*</span></label
                        >
                        <div class="col-lg-6">
                          <div class="form-group">
                            <label
                              class="img-label"
                              data-toggle="tooltip"
                              title="Select photo"
                            >
                              <img
                                class="rounded"
                                id="photo"
                                src="<%= book.imgUrl %>"
                                alt="Image"
                              />
                              <input
                                type="file"
                                class="sr-only"
                                id="uploadImg"
                                name="uploadImg"
                                accept="images/*"
                              />
                            </label>
                          </div>
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="copy">Copy Count</label>
                        <input
                          type="number"
                          class="form-control"
                          id="copy"
                          value="<%= book.copy %>"
                          name="copy"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label for="mainCat">Main Category</label>
                        <select
                          class="form-control"
                          id="mainCat"
                          name="mainCat"
                          required
                        >
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="subCat">Sub Category</label>
                        <select
                          class="form-control"
                          id="subCat"
                          name="subCat"
                          required
                        >
                        </select>
                      </div>

                      <div class="form-group">
                        <label for="rTime">Borrowing Duration</label>
                        <input
                          type="number"
                          class="form-control"
                          id="rTime"
                          value="<%= book.rTime %>"
                          name="rTime"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label for="pages">Pages</label>
                        <input
                          type="number"
                          class="form-control"
                          id="pages"
                          value="<%= book.pages %>"
                          name="pages"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label for="shelf">Book Shelf</label>
                        <select
                          name="shelf"
                          class="form-control"
                          id="shelf"
                          required
                        >
                          <option value="A1" <%= (book.shelf == "A1")? "selected": "" %> >A1</option>
                          <option value="A2" <%= (book.shelf == "A2")? "selected": "" %> >A2</option>
                          <option value="A3" <%= (book.shelf == "A3")? "selected": "" %> >A3</option>
                          <option value="A4" <%= (book.shelf == "A4")? "selected": "" %> >A4</option>
                          <option value="A5" <%= (book.shelf == "A5")? "selected": "" %> >A5</option>
                          <option value="A6" <%= (book.shelf == "A6")? "selected": "" %> >A6</option>
                          <option value="A7" <%= (book.shelf == "A7")? "selected": "" %> >A7</option>
                          <option value="A8" <%= (book.shelf == "A8")? "selected": "" %> >A8</option>
                          <option value="A9" <%= (book.shelf == "A9")? "selected": "" %> >A9</option>
                          <option value="B1" <%= (book.shelf == "B1")? "selected": "" %> >B1</option>
                          <option value="B2" <%= (book.shelf == "B2")? "selected": "" %> >B2</option>
                          <option value="B3" <%= (book.shelf == "B3")? "selected": "" %> >B3</option>
                          <option value="B4" <%= (book.shelf == "B4")? "selected": "" %> >B4</option>
                          <option value="B5" <%= (book.shelf == "B5")? "selected": "" %> >B5</option>
                          <option value="B6" <%= (book.shelf == "B6")? "selected": "" %> >B6</option>
                          <option value="B7" <%= (book.shelf == "B7")? "selected": "" %> >B7</option>
                          <option value="B8" <%= (book.shelf == "B8")? "selected": "" %> >B8</option>
                          <option value="B9" <%= (book.shelf == "B9")? "selected": "" %> >B9</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="desc">Description</label>
                        <input
                          type="text"
                          class="form-control"
                          id="desc"
                          value="<%= book.description %>"
                          name="desc"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label for="barcode">Barcode</label>
                        <input
                          type="text"
                          class="form-control"
                          id="barcode"
                          value="<%= book.barcode %>"
                          name="barcode"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label for="status">Status</label>
                        <select name="status" id="status" class="form-control">
                          <option value="1" <%= (book.status == '1')? "selected":"" %> >Active</option>
                          <option value="0" <%= (book.status == '0')? "selected":"" %> >Inactive</option>
                        </select>
                      </div>

                      <button
                        type="button"
                        id="save"
                        class="btn btn-primary mr-2"
                      >
                        Submit
                      </button>
                      <button class="btn btn-light">Cancel</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal fade" id="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-md" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title" id="largeModalLabel">Modal title</h4>
                </div>
                <div class="modal-body">
                  <div class="img-container">
                    <img src="/images/upload.png" id="sourceImg" alt="" />
                  </div>
                </div>
                <div class="modal-footer">
                  <button
                    id="crop"
                    type="button"
                    class="btn btn-link waves-effect"
                  >
                    Crop
                  </button>
                  <button
                    type="button"
                    class="btn btn-link waves-effect"
                    data-dismiss="modal"
                  >
                    CLOSE
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- content-wrapper ends -->
          <!-- partial:../../partials/_footer.html -->
          <% include ../../partialA/footer %>
          <!-- partial -->
        </div>
        <!-- main-panel ends -->
      </div>
      <!-- page-body-wrapper ends -->
    </div>
    <!-- container-scroller -->
    <!-- plugins:js -->
    <script src="/assets/vendors/js/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- Plugin js for this page -->
    <!-- End plugin js for this page -->
    <!-- inject:js -->
    <script src="/assets/js/off-canvas.js"></script>
    <script src="/assets/js/hoverable-collapse.js"></script>
    <script src="/assets/js/misc.js"></script>
    <!-- endinject -->
    <!-- Custom js for this page -->
    <!-- End custom js for this page -->
  </body>
  <script src="/javascripts/cropper.min.js"></script>
  <script>
    var categories = [<%- categories%>];
    console.log(categories);

    addOptions('mainCat', categories);
    $("#mainCat").on('change', function(){
        var sub = $.grep( categories, function( n, i ) {
          return n.mainCat == $("#mainCat").val();
        });
        addOptions('subCat', sub);
    });

    function addOptions(id, arr){
        $("#"+id).children().remove();
        for(var idx in arr){
            if(idx == 0) $("#"+id).append(new Option('Select '+((id == 'mainCat')? "Main Category": "Sub Category"), ''));
            if(idx == 0 || arr[idx][id] != arr[idx-1][id]){
                $("#"+id).append(new Option(((id == 'mainCat')? arr[idx][id]:arr[idx][id]),arr[idx][id]));

            }
        }
    }
    var $modal = $('#modal');
           var uploadImg = document.getElementById('uploadImg'); // upload file
           uploadImg.addEventListener('change', function (e) {
               var files = e.target.files;
               var done = function (url) {
                 uploadImg.value = '';
                 $('#sourceImg').attr('src', url);
                 $modal.modal('show');
               };
               var reader;
               var file;
               var url;
               if (files && files.length > 0) {
                 file = files[0];
                 if (URL) {
                   done(URL.createObjectURL(file));
                 } else if (FileReader) {
                   reader = new FileReader();
                   reader.onload = function (e) {
                     done(reader.result);
                   };
                   reader.readAsDataURL(file);
                 }
               }
           });
           var cropper;
           var canvas;
           var sourceImg = document.getElementById('sourceImg');
           $modal.on('shown.bs.modal', function () {
             cropper = new Cropper(sourceImg, {
                 aspectRatio: 3 / 4,
                 preview: '.img-preview',
                 viewMode: 1,
             });
           }).on('hidden.bs.modal', function () {
             cropper.destroy();
             cropper = null;
           });
           $('#crop').click( function () {
             $modal.modal('hide');
             if (cropper) {
               canvas = cropper.getCroppedCanvas({
                 width: 340,
                 height: 510,
               });
               $('#photo').attr('src', canvas.toDataURL() ); // change cropped image
             }
           });
           $('#save').click(function(){
            // $('#frm').valid();
               canvas.toBlob(function (blob) {
                   var formData = new FormData(document.getElementById('frm'));
                   formData.append('photo', blob);
                   console.log('fd',formData.title);
                   $.ajax('/admin/updateBook', {
                     method: 'POST',
                     data: formData,
                     processData: false,
                     contentType: false,
                     success: function (rtn) {
                         console.log(rtn)
                         if(rtn.status) location.href = '/admin/booklist'
                     },
                     error: function (err) {
                         console.log(err);
                     },
                     complete: function () {
                         console.log('complate');
                     },
                   });
               });
           });
  </script>
</html>
